<!-- public/admin/stats-export.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–≠–∫—Å–ø–æ—Ä—Ç ‚Äî QR Redirect</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="app-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="index.html" class="logo"><div class="logo-icon">Q</div>QR Redirect</a>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <a href="index.html" class="nav-item"><span class="nav-item-icon">üìä</span>–î–∞—à–±–æ—Ä–¥</a>
                    <a href="links.html" class="nav-item active"><span class="nav-item-icon">üîó</span>–í—Å–µ —Å—Å—ã–ª–∫–∏</a>
                    <a href="qr-generator.html" class="nav-item"><span class="nav-item-icon">üé®</span>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä QR</a>
                </div>
            </nav>
        </aside>

        <main class="main-content">
            <div class="page-container">
                <div class="page-header">
                    <div class="page-header-row">
                        <div>
                            <h1 class="page-title">–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h1>
                            <p class="page-subtitle">–°–∫–∞—á–∞–π—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ CSV</p>
                        </div>
                        <a href="links.html" class="btn btn-ghost">‚Üê –ù–∞–∑–∞–¥</a>
                    </div>
                </div>

                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:24px;">
                    <!-- Export all links -->
                    <div class="card">
                        <h3 style="margin-bottom:16px;">üìã –í—Å–µ —Å—Å—ã–ª–∫–∏</h3>
                        <p style="color:var(--text-secondary);margin-bottom:20px;font-size:0.9375rem;">
                            –≠–∫—Å–ø–æ—Ä—Ç —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö –≤–∞—à–∏—Ö —Å—Å—ã–ª–æ–∫ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø–µ—Ä–µ—Ö–æ–¥–æ–≤.
                        </p>
                        <a href="/api/stats/export-all" class="btn btn-primary" download id="export-all">
                            üì• –°–∫–∞—á–∞—Ç—å CSV
                        </a>
                    </div>

                    <!-- Export clicks for specific link -->
                    <div class="card">
                        <h3 style="margin-bottom:16px;">üìä –ü–µ—Ä–µ—Ö–æ–¥—ã –ø–æ —Å—Å—ã–ª–∫–µ</h3>
                        <p style="color:var(--text-secondary);margin-bottom:20px;font-size:0.9375rem;">
                            –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Å—ã–ª–∫–∏.
                        </p>

                        <div class="form-group">
                            <label>–í—ã–±–µ—Ä–∏—Ç–µ —Å—Å—ã–ª–∫—É</label>
                            <select id="link-select">
                                <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>–ü–µ—Ä–∏–æ–¥</label>
                            <select id="period-select">
                                <option value="">–í—Å—ë –≤—Ä–µ–º—è</option>
                                <option value="7">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</option>
                                <option value="30" selected>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</option>
                                <option value="90">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 90 –¥–Ω–µ–π</option>
                                <option value="365">–ü–æ—Å–ª–µ–¥–Ω–∏–π –≥–æ–¥</option>
                            </select>
                        </div>

                        <button class="btn btn-primary" id="export-clicks" disabled>
                            üì• –°–∫–∞—á–∞—Ç—å CSV
                        </button>
                    </div>
                </div>

                <!-- Preview -->
                <div class="card" style="margin-top:24px;">
                    <h3 style="margin-bottom:16px;">‚ÑπÔ∏è –ß—Ç–æ –≤–∫–ª—é—á–µ–Ω–æ –≤ —ç–∫—Å–ø–æ—Ä—Ç</h3>

                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:24px;">
                        <div>
                            <h4 style="font-size:0.875rem;margin-bottom:12px;color:var(--text-secondary);">–≠–∫—Å–ø–æ—Ä—Ç —Å—Å—ã–ª–æ–∫</h4>
                            <ul style="list-style:none;font-size:0.875rem;color:var(--text-secondary);">
                                <li style="padding:4px 0;">‚úì Slug</li>
                                <li style="padding:4px 0;">‚úì –¶–µ–ª–µ–≤–æ–π URL</li>
                                <li style="padding:4px 0;">‚úì –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</li>
                                <li style="padding:4px 0;">‚úì –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤</li>
                                <li style="padding:4px 0;">‚úì –°—Ç–∞—Ç—É—Å (–∞–∫—Ç–∏–≤–Ω–∞/–Ω–µ–∞–∫—Ç–∏–≤–Ω–∞)</li>
                                <li style="padding:4px 0;">‚úì –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</li>
                            </ul>
                        </div>

                        <div>
                            <h4 style="font-size:0.875rem;margin-bottom:12px;color:var(--text-secondary);">–≠–∫—Å–ø–æ—Ä—Ç –ø–µ—Ä–µ—Ö–æ–¥–æ–≤</h4>
                            <ul style="list-style:none;font-size:0.875rem;color:var(--text-secondary);">
                                <li style="padding:4px 0;">‚úì –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</li>
                                <li style="padding:4px 0;">‚úì IP-–∞–¥—Ä–µ—Å</li>
                                <li style="padding:4px 0;">‚úì –°—Ç—Ä–∞–Ω–∞</li>
                                <li style="padding:4px 0;">‚úì –ì–æ—Ä–æ–¥</li>
                                <li style="padding:4px 0;">‚úì –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</li>
                                <li style="padding:4px 0;">‚úì –ë—Ä–∞—É–∑–µ—Ä</li>
                                <li style="padding:4px 0;">‚úì –û–°</li>
                                <li style="padding:4px 0;">‚úì –ò—Å—Ç–æ—á–Ω–∏–∫ (Referrer)</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="js/app.js"></script>
    <script>
        (function() {
            var QR = window.QRAdmin;
            if (!QR.isAuthenticated()) { location.href = 'login.html'; return; }

            var selectedLink = null;

            // Auth header for downloads
            var token = localStorage.getItem('access_token');

            document.getElementById('export-all').onclick = async function(e) {
                e.preventDefault();

                try {
                    var res = await fetch('/api/stats/export-all', {
                        headers: { 'Authorization': 'Bearer ' + token }
                    });

                    if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞');

                    var blob = await res.blob();
                    var url = URL.createObjectURL(blob);
                    var a = document.createElement('a');
                    a.href = url;
                    a.download = 'all-links.csv';
                    a.click();

                    QR.showAlert('–§–∞–π–ª —Å–∫–∞—á–∞–Ω!');
                } catch (err) {
                    QR.showAlert(err.message, 'error');
                }
            };

            // Load links
            QR.api('/redirects').then(function(links) {
                var select = document.getElementById('link-select');
                select.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>';
                links.forEach(function(l) {
                    select.innerHTML += '<option value="' + l.id + '">/qr/' + QR.escapeHtml(l.slug) + '</option>';
                });
            });

            // Link select
            document.getElementById('link-select').onchange = function() {
                selectedLink = this.value;
                document.getElementById('export-clicks').disabled = !selectedLink;
            };

            // Export clicks
            document.getElementById('export-clicks').onclick = async function() {
                if (!selectedLink) return;

                var days = document.getElementById('period-select').value;
                var url = '/api/stats/export/' + selectedLink;
                if (days) url += '?days=' + days;

                try {
                    var res = await fetch(url, {
                        headers: { 'Authorization': 'Bearer ' + token }
                    });

                    if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞');

                    var blob = await res.blob();
                    var blobUrl = URL.createObjectURL(blob);
                    var a = document.createElement('a');
                    a.href = blobUrl;
                    a.download = 'clicks-export.csv';
                    a.click();

                    QR.showAlert('–§–∞–π–ª —Å–∫–∞—á–∞–Ω!');
                } catch (err) {
                    QR.showAlert(err.message, 'error');
                }
            };
        })();
    </script>
</body>
</html>