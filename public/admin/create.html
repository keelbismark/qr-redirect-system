<!-- public/admin/create.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù–æ–≤–∞—è —Å—Å—ã–ª–∫–∞ ‚Äî QR Redirect</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="app-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="index.html" class="logo"><div class="logo-icon">Q</div>QR Redirect</a>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <a href="index.html" class="nav-item"><span class="nav-item-icon">üìä</span>–î–∞—à–±–æ—Ä–¥</a>
                    <a href="links.html" class="nav-item active"><span class="nav-item-icon">üîó</span>–í—Å–µ —Å—Å—ã–ª–∫–∏</a>
                    <a href="qr-generator.html" class="nav-item"><span class="nav-item-icon">üé®</span>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä QR</a>
                </div>
            </nav>
        </aside>

        <main class="main-content">
            <div class="page-container">
                <div class="page-header">
                    <div class="page-header-row">
                        <div>
                            <h1 class="page-title">–ù–æ–≤–∞—è —Å—Å—ã–ª–∫–∞</h1>
                            <p class="page-subtitle">–°–æ–∑–¥–∞–π—Ç–µ –∫–æ—Ä–æ—Ç–∫—É—é —Å—Å—ã–ª–∫—É –¥–ª—è QR-–∫–æ–¥–∞</p>
                        </div>
                        <a href="links.html" class="btn btn-ghost">‚Üê –ù–∞–∑–∞–¥</a>
                    </div>
                </div>

                <div class="card" style="max-width:640px;">
                    <form id="form">
                        <!-- –û—Å–Ω–æ–≤–Ω–æ–µ -->
                        <h3 style="margin-bottom:20px;">–û—Å–Ω–æ–≤–Ω–æ–µ</h3>

                        <div class="form-group">
                            <label>Slug *</label>
                            <div class="input-group">
                                <span class="input-prefix" id="prefix">/qr/</span>
                                <input type="text" id="slug" placeholder="promo-2024" required>
                            </div>
                            <div class="input-hint">–¢–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –¥–µ—Ñ–∏—Å. –ù–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å.</div>
                            <div id="slug-error" class="input-error" style="display:none;"></div>
                        </div>

                        <div class="form-group">
                            <label>–¶–µ–ª–µ–≤–æ–π URL *</label>
                            <input type="url" id="url" placeholder="https://example.com/page" required>
                            <div id="url-error" class="input-error" style="display:none;"></div>
                        </div>

                        <div class="form-group">
                            <label>–ü–∞–ø–∫–∞ <span class="label-optional">(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</span></label>
                            <select id="folder">
                                <option value="">–ë–µ–∑ –ø–∞–ø–∫–∏</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π <span class="label-optional">(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</span></label>
                            <textarea id="comment" placeholder="–ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —ç—Ç–æ—Ç QR?"></textarea>
                        </div>

                        <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ -->
                        <h3 style="margin:32px 0 20px;">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</h3>

                        <div class="form-grid form-grid-2">
                            <div class="form-group">
                                <label>–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è</label>
                                <input type="datetime-local" id="expires">
                                <div class="input-hint">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –±–µ—Å—Å—Ä–æ—á–Ω–æ–π —Å—Å—ã–ª–∫–∏</div>
                            </div>

                            <div class="form-group">
                                <label>–ü–∞—Ä–æ–ª—å</label>
                                <input type="text" id="password" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º">
                                <div class="input-hint">–ó–∞—â–∏—Ç–∏—Ç–µ —Å—Å—ã–ª–∫—É –ø–∞—Ä–æ–ª–µ–º</div>
                            </div>
                        </div>

                        <!-- UTM -->
                        <h3 style="margin:32px 0 20px;">UTM-–º–µ—Ç–∫–∏</h3>

                        <div class="form-grid form-grid-2">
                            <div class="form-group">
                                <label>utm_source</label>
                                <input type="text" id="utm-source" placeholder="qr">
                            </div>
                            <div class="form-group">
                                <label>utm_medium</label>
                                <input type="text" id="utm-medium" placeholder="offline">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>utm_campaign</label>
                            <input type="text" id="utm-campaign" placeholder="promo-winter">
                        </div>

                        <div class="form-actions">
                            <a href="links.html" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</a>
                            <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <script src="js/app.js"></script>
    <script>
        (function() {
            var QR = window.QRAdmin;
            if (!QR.isAuthenticated()) { location.href = 'login.html'; return; }

            document.getElementById('prefix').textContent = location.origin + '/qr/';

            // Load folders
            QR.api('/folders').then(function(folders) {
                var select = document.getElementById('folder');
                folders.forEach(function(f) {
                    select.innerHTML += '<option value="' + f.id + '">' + QR.escapeHtml(f.name) + '</option>';
                });
            });

            // Slug validation
            document.getElementById('slug').oninput = function(e) {
                var v = e.target.value.replace(/[^a-zA-Z0-9\-_]/g, '').toLowerCase();
                e.target.value = v;
            };

            // Submit
            document.getElementById('form').onsubmit = async function(e) {
                e.preventDefault();
                var btn = this.querySelector('button[type="submit"]');

                document.getElementById('slug-error').style.display = 'none';
                document.getElementById('url-error').style.display = 'none';

                btn.disabled = true;
                btn.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ...';

                try {
                    var data = {
                        slug: document.getElementById('slug').value,
                        targetUrl: document.getElementById('url').value,
                        folderId: document.getElementById('folder').value || null,
                        comment: document.getElementById('comment').value,
                        expiresAt: document.getElementById('expires').value || null,
                        password: document.getElementById('password').value || null,
                        utmSource: document.getElementById('utm-source').value || null,
                        utmMedium: document.getElementById('utm-medium').value || null,
                        utmCampaign: document.getElementById('utm-campaign').value || null
                    };

                    await QR.api('/redirects', { method: 'POST', body: JSON.stringify(data) });
                    QR.showAlert('–°—Å—ã–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!');
                    location.href = 'links.html';
                } catch (err) {
                    if (err.data && err.data.errors) {
                        if (err.data.errors.slug) {
                            document.getElementById('slug-error').textContent = err.data.errors.slug;
                            document.getElementById('slug-error').style.display = 'block';
                        }
                        if (err.data.errors.targetUrl) {
                            document.getElementById('url-error').textContent = err.data.errors.targetUrl;
                            document.getElementById('url-error').style.display = 'block';
                        }
                    } else {
                        QR.showAlert(err.message, 'error');
                    }
                    btn.disabled = false;
                    btn.textContent = '–°–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É';
                }
            };
        })();
    </script>
</body>
</html>