<!-- public/admin/edit.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî QR Redirect</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="app-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="index.html" class="logo"><div class="logo-icon">Q</div>QR Redirect</a>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <a href="index.html" class="nav-item"><span class="nav-item-icon">üìä</span>–î–∞—à–±–æ—Ä–¥</a>
                    <a href="links.html" class="nav-item active"><span class="nav-item-icon">üîó</span>–í—Å–µ —Å—Å—ã–ª–∫–∏</a>
                    <a href="qr-generator.html" class="nav-item"><span class="nav-item-icon">üé®</span>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä QR</a>
                </div>
            </nav>
        </aside>

        <main class="main-content">
            <div class="page-container" id="app">
                <div class="loading"><div class="spinner"></div><p>–ó–∞–≥—Ä—É–∑–∫–∞</p></div>
            </div>
        </main>
    </div>

    <script src="js/app.js"></script>
    <script>
        (function() {
            var QR = window.QRAdmin;
            if (!QR.isAuthenticated()) { location.href = 'login.html'; return; }

            var id = new URLSearchParams(location.search).get('id');
            if (!id) { location.href = 'links.html'; return; }

            var redirect = null;
            var folders = [];

            async function init() {
                try {
                    [redirect, folders] = await Promise.all([
                        QR.api('/redirects/' + id),
                        QR.api('/folders')
                    ]);
                    render();
                } catch (err) {
                    QR.showAlert(err.message, 'error');
                    location.href = 'links.html';
                }
            }

            function render() {
                var folderOptions = '<option value="">–ë–µ–∑ –ø–∞–ø–∫–∏</option>' +
                    folders.map(function(f) {
                        return '<option value="' + f.id + '"' + (redirect.folder_id == f.id ? ' selected' : '') + '>' + QR.escapeHtml(f.name) + '</option>';
                    }).join('');

                var expiresValue = '';
                if (redirect.expires_at) {
                    var d = new Date(redirect.expires_at);
                    expiresValue = d.toISOString().slice(0, 16);
                }

                var html = '<div class="page-header"><div class="page-header-row">' +
                    '<div><h1 class="page-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h1>' +
                    '<p class="page-subtitle">–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Å—Å—ã–ª–∫–∏</p></div>' +
                    '<div class="page-actions">' +
                    '<a href="stats.html?id=' + id + '" class="btn btn-secondary">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>' +
                    '<a href="links.html" class="btn btn-ghost">‚Üê –ù–∞–∑–∞–¥</a>' +
                    '</div></div></div>' +

                    '<div class="card" style="max-width:640px;">' +

                    '<!-- –ü–æ—Å—Ç–æ—è–Ω–Ω–∞—è —Å—Å—ã–ª–∫–∞ -->' +
                    '<div style="background:var(--bg);padding:16px;border-radius:var(--radius);margin-bottom:24px;">' +
                    '<div style="font-size:0.75rem;color:var(--text-muted);margin-bottom:4px;">–ü–æ—Å—Ç–æ—è–Ω–Ω–∞—è —Å—Å—ã–ª–∫–∞ (–≤ QR-–∫–æ–¥–µ)</div>' +
                    '<div style="display:flex;align-items:center;gap:12px;">' +
                    '<code style="font-family:JetBrains Mono,monospace;font-size:0.9375rem;color:var(--accent);">' + location.origin + '/qr/' + QR.escapeHtml(redirect.slug) + '</code>' +
                    '<button type="button" class="btn btn-sm btn-secondary" id="copy-link">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>' +
                    '</div></div>' +

                    '<form id="form">' +

                    '<!-- –û—Å–Ω–æ–≤–Ω–æ–µ -->' +
                    '<h3 style="margin-bottom:20px;">–û—Å–Ω–æ–≤–Ω–æ–µ</h3>' +

                    '<div class="form-group">' +
                    '<label>–¶–µ–ª–µ–≤–æ–π URL *</label>' +
                    '<input type="url" id="url" value="' + QR.escapeHtml(redirect.target_url) + '" required>' +
                    '<div id="url-error" class="input-error" style="display:none;"></div>' +
                    '</div>' +

                    '<div class="form-group">' +
                    '<label>–ü–∞–ø–∫–∞</label>' +
                    '<select id="folder">' + folderOptions + '</select>' +
                    '</div>' +

                    '<div class="form-group">' +
                    '<label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>' +
                    '<textarea id="comment">' + QR.escapeHtml(redirect.comment || '') + '</textarea>' +
                    '</div>' +

                    '<div class="form-group">' +
                    '<label class="checkbox-label">' +
                    '<input type="checkbox" id="active"' + (redirect.is_active ? ' checked' : '') + '>' +
                    '<span>–°—Å—ã–ª–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞</span>' +
                    '</label>' +
                    '<div class="input-hint">–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É-–∑–∞–≥–ª—É—à–∫—É</div>' +
                    '</div>' +

                    '<!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ -->' +
                    '<h3 style="margin:32px 0 20px;">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</h3>' +

                    '<div class="form-grid form-grid-2">' +
                    '<div class="form-group">' +
                    '<label>–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è</label>' +
                    '<input type="datetime-local" id="expires" value="' + expiresValue + '">' +
                    '<div class="input-hint">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –±–µ—Å—Å—Ä–æ—á–Ω–æ–π</div>' +
                    '</div>' +

                    '<div class="form-group">' +
                    '<label>–ü–∞—Ä–æ–ª—å</label>' +
                    '<input type="text" id="password" placeholder="' + (redirect.password_hash ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : '–ë–µ–∑ –ø–∞—Ä–æ–ª—è') + '">' +
                    '<div class="input-hint">' + (redirect.password_hash ? '–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π' : '–í–≤–µ–¥–∏—Ç–µ –¥–ª—è –∑–∞—â–∏—Ç—ã') + '</div>' +
                    '</div>' +
                    '</div>' +

                    '<!-- UTM -->' +
                    '<h3 style="margin:32px 0 20px;">UTM-–º–µ—Ç–∫–∏</h3>' +

                    '<div class="form-grid form-grid-2">' +
                    '<div class="form-group">' +
                    '<label>utm_source</label>' +
                    '<input type="text" id="utm-source" value="' + QR.escapeHtml(redirect.utm_source || '') + '" placeholder="qr">' +
                    '</div>' +
                    '<div class="form-group">' +
                    '<label>utm_medium</label>' +
                    '<input type="text" id="utm-medium" value="' + QR.escapeHtml(redirect.utm_medium || '') + '" placeholder="offline">' +
                    '</div>' +
                    '</div>' +

                    '<div class="form-group">' +
                    '<label>utm_campaign</label>' +
                    '<input type="text" id="utm-campaign" value="' + QR.escapeHtml(redirect.utm_campaign || '') + '" placeholder="promo">' +
                    '</div>' +

                    '<!-- QR —Å –ª–æ–≥–æ—Ç–∏–ø–æ–º -->' +
                    '<h3 style="margin:32px 0 20px;">–õ–æ–≥–æ—Ç–∏–ø –¥–ª—è QR</h3>' +

                    '<div class="form-group">' +
                    '<div class="logo-upload" id="logo-upload">' +
                    (redirect.logo_url ?
                        '<img src="/' + redirect.logo_url + '" class="logo-preview" id="logo-preview"><div class="logo-upload-text">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–º–µ–Ω—ã</div>' :
                        '<div class="logo-upload-text">üì∑ –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ—Ç–∏–ø–∞<br><small>PNG, JPG –¥–æ 500KB</small></div>'
                    ) +
                    '</div>' +
                    '<input type="file" id="logo-input" accept="image/*" style="display:none">' +
                    '</div>' +

                    '<div class="form-actions">' +
                    '<button type="button" class="btn btn-danger" id="delete-btn">–£–¥–∞–ª–∏—Ç—å</button>' +
                    '<div style="flex:1;"></div>' +
                    '<a href="links.html" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</a>' +
                    '<button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>' +
                    '</div>' +

                    '</form></div>';

                document.getElementById('app').innerHTML = html;
                bindEvents();
            }

            function bindEvents() {
                // Copy link
                document.getElementById('copy-link').onclick = function() {
                    QR.copyToClipboard(location.origin + '/qr/' + redirect.slug);
                };

                // Logo upload
                var logoUpload = document.getElementById('logo-upload');
                var logoInput = document.getElementById('logo-input');

                logoUpload.onclick = function() { logoInput.click(); };

                logoInput.onchange = async function() {
                    if (!this.files[0]) return;

                    var formData = new FormData();
                    formData.append('logo', this.files[0]);

                    try {
                        var res = await fetch('/api/redirects/' + id + '/logo', {
                            method: 'POST',
                            headers: { 'Authorization': 'Bearer ' + localStorage.getItem('access_token') },
                            body: formData
                        });

                        var data = await res.json();
                        if (!res.ok) throw new Error(data.error);

                        QR.showAlert('–õ–æ–≥–æ—Ç–∏–ø –∑–∞–≥—Ä—É–∂–µ–Ω!');

                        // Update preview
                        logoUpload.innerHTML = '<img src="/' + data.logoUrl + '" class="logo-preview"><div class="logo-upload-text">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–º–µ–Ω—ã</div>';
                        logoUpload.classList.add('has-logo');
                    } catch (err) {
                        QR.showAlert(err.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', 'error');
                    }
                };

                // Delete
                document.getElementById('delete-btn').onclick = function() {
                    QR.showConfirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —Å—Å—ã–ª–∫—É? –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.', async function() {
                        try {
                            await QR.api('/redirects/' + id, { method: 'DELETE' });
                            QR.showAlert('–°—Å—ã–ª–∫–∞ —É–¥–∞–ª–µ–Ω–∞');
                            location.href = 'links.html';
                        } catch (err) {
                            QR.showAlert(err.message, 'error');
                        }
                    });
                };

                // Submit
                document.getElementById('form').onsubmit = async function(e) {
                    e.preventDefault();
                    var btn = this.querySelector('button[type="submit"]');

                    document.getElementById('url-error').style.display = 'none';

                    btn.disabled = true;
                    btn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

                    try {
                        var data = {
                            targetUrl: document.getElementById('url').value,
                            folderId: document.getElementById('folder').value || null,
                            comment: document.getElementById('comment').value,
                            isActive: document.getElementById('active').checked,
                            expiresAt: document.getElementById('expires').value || null,
                            utmSource: document.getElementById('utm-source').value || null,
                            utmMedium: document.getElementById('utm-medium').value || null,
                            utmCampaign: document.getElementById('utm-campaign').value || null
                        };

                        // Password: only send if changed
                        var pwd = document.getElementById('password').value;
                        if (pwd) data.password = pwd;

                        await QR.api('/redirects/' + id, { method: 'PUT', body: JSON.stringify(data) });
                        QR.showAlert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');
                        location.href = 'links.html';
                    } catch (err) {
                        if (err.data && err.data.errors && err.data.errors.targetUrl) {
                            document.getElementById('url-error').textContent = err.data.errors.targetUrl;
                            document.getElementById('url-error').style.display = 'block';
                        } else {
                            QR.showAlert(err.message, 'error');
                        }
                        btn.disabled = false;
                        btn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                    }
                };
            }

            init();
        })();
    </script>
</body>
</html>